---
- name: "Create the 'To:' list of addresses"
  set_fact:
    mail: "{{ mail | combine({ 'to': list_of_mail_to }) }}"
  when:
  - list_of_mail_to is defined

- name: "Create the 'CC:' list of addresses"
  set_fact:
    mail: "{{ mail | combine({ 'cc': list_of_mail_cc }) }}"
  when:
  - list_of_mail_cc is defined

- name: "Create the 'BCC:' list of addresses"
  set_fact:
    mail: "{{ mail | combine({ 'bcc': list_of_mail_bcc }) }}"
  when:
  - list_of_mail_bcc is defined

- name: "Send out notifying e-mail to customers"
  mail:
    subject: "{{ mail_body.{{template}}.subject }}"
    body: "{{ mail_body.{{template}}.body | default(omit) }}"
    host: "{{ mail_conf.host | default(omit) }}"
    port: "{{ mail_conf.port | default (omit) }}"
    username: "{{ mail_conf.username | default(omit) }}"
    password: "{{ mail_conf.password | default(omit) }}"
    to: "{{ mail_recipients.to | default(omit) }}"
    cc: "{{ mail_conf.cc | default(omit) }}"
    bcc: "{{ mail_conf.bcc | default(omit) }}"
    from: "{{ mail_conf.from | default(omit)}}"
    headers: "{{ mail_conf.headers | default(omit)}}"
    secure: "{{ mail_conf.secure | default(omit) }}"
    subtype: "{{ mail_conf.subtype | default(omit) }}"

# - name: Sending an information email to customer
#   gather_facts: no
#   hosts: localhost
#
#   tasks:
#   - name: First emails
#     mail:
#      host: "smtp.gmail.com"
#      port: 587
#      secure: "starttls"
#      username: "no-reply@aura.cz"
#      password: "4%Jm1@$8;6-Fq9"
#      to: "tadeas.resler@aura.cz"
#      #cc: "tomas.maca@aura.cz"
#      subject: "Ansible-report"
#      subtype: "html"
#      body: "Hello <b>Tomas</b>, this is the first e-mail in HTML format from ansible. I hope you like it ;-)"
#      from: "ansible@aura.cz"
#      timeout: 30
#      charset: "utf-8"
     #    cc: Tomas Maca <tomas.maca@aura.cz>
     #    attach: /etc/
     #    headers: 'Reply-To=tadeasresler@gmail.com|X-Special="Something or other"'
     #    charset: utf8
    #delegate_to: localhost
