---
# tasks file for package-security-check

- name: Creates a CRON for regular docker check everyday
  cron:
    name: Docker Update Check
    hour: 4
    minute: 15
    user: root
    job: "ansible-playbook /etc/ansible/roles/docker-image-vulnerability-check/docker-image-vulnerability-check.yml -e "dc_image_name='httpd'" --vault-password-file /etc/ansible/vault_passwd'"
    cron_file: ansible_docker_update_check

# - name: Deploy Cron
#   copy:
#     content: '0 1 * * * ansible-playbook /etc/ansible/roles/docker-image-vulnerability-check/docker-image-vulnerability-check.yml -e "dc_image_name='httpd'" --vault-password-file /etc/ansible/vault_passwd'
#     dest: ../send-email/templates/main.html
#   when: se_temp_type != ""

- name: Inspect a single image
  shell: curl 'https://registry.hub.docker.com/v2/repositories/library/{{ dc_image_name }}/tags/'|jq '."results"[]["name"]'
  register: docker_facts_results

- name: List of docker facts
  debug:
    msg: "{{ docker_facts_results.stdout_lines }}" #"| map(attribute='stdout_lines') | list }}"

- name: Create a file with today's docker hub version list
  copy:
    content: "{{ docker_facts_results.stdout_lines }}"
    dest: templates/today_docker_version.txt

- name: Compare files
  shell: diff templates/today_docker_version.txt templates/yesterday_docker_version.txt
  failed_when: "diff_output.rc > 1"
  register: diff_output

- name: Set variable
  set_fact:
   is_dc_version_different: "{{ diff_output.rc }}"

- name: Copy today's versions to yesterday's state
  template:
    src: templates/today_docker_version.txt
    dest: templates/yesterday_docker_version.txt
